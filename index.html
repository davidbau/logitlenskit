<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LogitLensKit - Interactive Logit Lens Visualization</title>
    <meta name="description" content="Interactive visualization toolkit for transformer logit lens analysis">
    <script src="preview_data.js"></script>
    <script src="preview_data_gptj.js"></script>
    <script src="js/src/logit-lens-widget.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { font-size: 24px; margin-bottom: 10px; }
        .subtitle { font-size: 14px; color: #666; margin-bottom: 20px; }
        .preview-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .note { font-size: 12px; color: #666; margin-bottom: 15px; }
        .project-links { margin-bottom: 20px; font-size: 13px; }
        .project-links a { color: #1976d2; text-decoration: none; margin-right: 15px; }
        .project-links a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>LogitLensKit</h1>
    <p class="subtitle">Interactive visualization toolkit for transformer logit lens analysis</p>
    <div class="project-links">
        <a href="https://github.com/davidbau/logitlenskit">GitHub Repository</a>
        <a href="https://github.com/davidbau/logitlenskit/blob/main/docs/JAVASCRIPT_API.md">JavaScript API</a>
        <a href="https://github.com/davidbau/logitlenskit/blob/main/docs/PYTHON_API.md">Python API</a>
    </div>
    <p class="note">Demo using real model data collected via NDIF. Click cells to see top-k predictions, click input tokens to pin rows for comparison.</p>
    <p style="margin-bottom: 15px;">
        <strong>Model:</strong>
        <button id="load-llama-btn" style="padding: 6px 12px; font-size: 13px; cursor: pointer; margin-left: 10px;">
            Llama 3.1 70B (80 layers)
        </button>
        <button id="load-gptj-btn" style="padding: 6px 12px; font-size: 13px; cursor: pointer; margin-left: 5px;">
            GPT-J 6B (28 layers)
        </button>
        <span id="current-model" style="margin-left: 10px; font-size: 12px; color: #666;">Currently: Llama 3.1 70B</span>
    </p>
    <div class="preview-container" id="viz"></div>
    <p style="margin-top: 20px;">
        <button id="duplicate-btn" style="padding: 8px 16px; font-size: 14px; cursor: pointer;">
            Duplicate Widget with Same State
        </button>
        <label id="link-label" style="margin-left: 15px; display: none;">
            <input type="checkbox" id="link-checkbox"> Link columns
        </label>
        <label style="margin-left: 15px;">
            <input type="checkbox" id="dark-mode-checkbox"> Dark mode
        </label>
        <span id="state-display" style="margin-left: 10px; font-size: 11px; color: #666;"></span>
    </p>
    <div class="preview-container" id="viz2" style="margin-top: 20px;"></div>

<script>
// Model data from NDIF
var dataLlama = (typeof PREVIEW_DATA !== 'undefined') ? PREVIEW_DATA : null;
var dataGptj = (typeof PREVIEW_DATA_GPTJ !== 'undefined') ? PREVIEW_DATA_GPTJ : null;

// Fallback data if neither loads
var fallbackData = {
    layers: [0, 1, 2, 3],
    tokens: ["Fallback", " data"],
    cells: [[{token:"test",prob:0.5,trajectory:[0.5,0.5,0.5,0.5],topk:[{token:"test",prob:0.5,trajectory:[0.5,0.5,0.5,0.5]}]}]]
};

// Current data and model name
var currentData = dataLlama || dataGptj || fallbackData;
var currentModel = dataLlama ? "Llama 3.1 70B" : (dataGptj ? "GPT-J 6B" : "Fallback");

// Create widget instance
var widget1 = LogitLensWidget("#viz", currentData);
var widget2 = null;

// Helper to reload widget with new data
function reloadWidget(data, modelName) {
    currentData = data;
    currentModel = modelName;

    // Get current dark mode state
    var isDarkMode = widget1 ? widget1.getDarkMode() : false;

    // Destroy and recreate widget1
    document.getElementById("viz").innerHTML = "";
    widget1 = LogitLensWidget("#viz", data, { darkMode: isDarkMode });

    // If widget2 exists, recreate it too
    if (widget2) {
        document.getElementById("viz2").innerHTML = "";
        widget2 = LogitLensWidget("#viz2", data, { darkMode: isDarkMode });
        if (document.getElementById("link-checkbox").checked) {
            widget1.linkColumnsTo(widget2);
        }
    }

    // Update label
    document.getElementById("current-model").textContent = "Currently: " + modelName;
}

// Model switching buttons
document.getElementById("load-llama-btn").addEventListener("click", function() {
    if (dataLlama) {
        reloadWidget(dataLlama, "Llama 3.1 70B");
    } else {
        alert("Llama data not available");
    }
});

document.getElementById("load-gptj-btn").addEventListener("click", function() {
    if (dataGptj) {
        reloadWidget(dataGptj, "GPT-J 6B");
    } else {
        alert("GPT-J data not available");
    }
});

// Duplicate button handler
document.getElementById("duplicate-btn").addEventListener("click", function() {
    var state = widget1.getState();
    document.getElementById("state-display").textContent = "State: " + JSON.stringify(state).substring(0, 100) + "...";

    // Clear viz2 and create new widget with same state
    document.getElementById("viz2").innerHTML = "";
    widget2 = LogitLensWidget("#viz2", currentData, state);

    // Show the link checkbox
    document.getElementById("link-label").style.display = "inline";

    // If checkbox is already checked, link the new widget
    if (document.getElementById("link-checkbox").checked) {
        widget1.linkColumnsTo(widget2);
    }
});

// Link checkbox handler
document.getElementById("link-checkbox").addEventListener("change", function() {
    if (!widget2) return;
    if (this.checked) {
        widget1.linkColumnsTo(widget2);
    } else {
        widget1.unlinkColumns(widget2);
        widget2.unlinkColumns(widget1);
    }
});

// Dark mode checkbox handler
document.getElementById("dark-mode-checkbox").addEventListener("change", function() {
    var enabled = this.checked;
    // Update page background
    document.body.style.background = enabled ? "#121212" : "#f5f5f5";
    document.body.style.color = enabled ? "#e0e0e0" : "";
    // Update preview containers
    document.querySelectorAll(".preview-container").forEach(function(el) {
        el.style.background = enabled ? "#1e1e1e" : "white";
    });
    // Update all widgets
    widget1.setDarkMode(enabled);
    if (widget2) {
        widget2.setDarkMode(enabled);
    }
});
</script>
</body>
</html>
